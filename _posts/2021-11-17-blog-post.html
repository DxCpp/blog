---
layout: post
title: Скрипт для проверки пользователей на удаленных компьютерах
date: '2021-11-17T17:58:00.006+03:00'
author: Rishat
tags:
- Active Directory
- PowerShell
- Windows
modified_time: '2021-11-17T18:29:48.145+03:00'
thumbnail: https://blogger.googleusercontent.com/img/a/AVvXsEh_QMqTnvRatuPJjMHpQv3dQPqRZyWsZdCDzIIZM1s9nXIHAqqtge_TFx5j7Fqh2XTJdAV-TyRjrCx6OPJiMRhBVLPRtDdibydX9co9HfT4LiHzOvmkO4SzB9vaZNZckAkKHlefVsuHatVXM_e4CRu8sBdur9O7bDbGAyMi2djcoqnbl6dk977JIjs1vQ=s72-w640-c-h367
blogger_id: tag:blogger.com,1999:blog-632559424411275764.post-1186068472923319868
blogger_orig_url: https://dxcpp.blogspot.com/2021/11/blog-post.html
---

<p>Если вам нужно собрать информацию о пользователях сразу с нескольких компьютерах, можете использовать следующую PowerShell функцию получить имена пользователей.</p> <pre class="prettyprint linenums lang-cpp">function Get-LoggedUser<br />{<br />    [CmdletBinding()]<br />    param<br />    (<br />        [string[]]$ComputerName <br />    )<br />    foreach ($comp in $ComputerName)<br />    {<br />        $output = @{'Computer' = $comp }<br />        $output.UserName = (Get-WmiObject -Class win32_computersystem -ComputerName $comp).UserName<br />        [PSCustomObject]$output<br />    }<br />}<br /></pre> <p>На вход функции Get-LoggedUser нужно передать имена компьютеров, на которых нужно проверить имена пользователей: </p><pre class="prettyprint linenums lang-cpp">Get-LoggedUser wks215s1,wks215s2,dc01<br /></pre> <p><span></span></p><a name='more'></a>На вход функции Get-LoggedUser нужно передать имена компьютеров, на которых нужно проверить имена пользователей: <p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEh_QMqTnvRatuPJjMHpQv3dQPqRZyWsZdCDzIIZM1s9nXIHAqqtge_TFx5j7Fqh2XTJdAV-TyRjrCx6OPJiMRhBVLPRtDdibydX9co9HfT4LiHzOvmkO4SzB9vaZNZckAkKHlefVsuHatVXM_e4CRu8sBdur9O7bDbGAyMi2djcoqnbl6dk977JIjs1vQ=s750" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="430" data-original-width="750" height="367" src="https://blogger.googleusercontent.com/img/a/AVvXsEh_QMqTnvRatuPJjMHpQv3dQPqRZyWsZdCDzIIZM1s9nXIHAqqtge_TFx5j7Fqh2XTJdAV-TyRjrCx6OPJiMRhBVLPRtDdibydX9co9HfT4LiHzOvmkO4SzB9vaZNZckAkKHlefVsuHatVXM_e4CRu8sBdur9O7bDbGAyMi2djcoqnbl6dk977JIjs1vQ=w640-h367" width="640" /></a></div><p>Если для какого-то компьютера функция вернула пустое имя пользователя, значит на компьютер никто не залогинен.</p><p>Можно получить имена пользователей, которые работают на компьютерах в домене Active Directory. Для получения списка компьютеров нужно использовать командлет Get-ADComputer. В следующем примере мы получим имена пользователей, которые работают за активными компьютерами в определенном OU домена. Чтобы скрипт работал быстрее перед тем, как обратится к обратится к удаленному компьютеру, я добавил проверку его доступности по сети через ICMP пинг с помощью командлета Test-NetConnection:</p> <pre class="prettyprint linenums lang-cpp">function Get-LoggedUser<br />{<br />    [CmdletBinding()]<br />    param<br />    (<br />        [string[]]$ComputerName <br />    )<br />    foreach ($comp in $ComputerName)<br />    {<br />        if ((Test-NetConnection $comp -WarningAction SilentlyContinue).PingSucceeded -eq $true) <br />            {  <br />                $output = @{'Computer' = $comp }<br />                $output.UserName = (Get-WmiObject -Class win32_computersystem -ComputerName $comp).UserName<br />            }<br />            else<br />            {<br />                $output = @{'Computer' = $comp }<br />                         $output.UserName = "offline"<br />            }<br />         [PSCustomObject]$output <br />    }<br />}<br />$computers = (Get-AdComputer -Filter {enabled -eq "true"} -SearchBase 'OU=spb,DC=test,DC=loc').Name<br />Get-LoggedUser $computers |ft -AutoSize<br /></pre><p></p><div class="separator" style="clear: both;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhhK5AND-53hO0WmWbQFMTGM0pr14PtX-ckX9CvIVr8PkMr_kmRLkQI-wK-V9Rmr5140t6sejSnmIYb9hhvRbXXWsdtdDVGG8KU7mMIMxmraFoMJUIwYPMzCTZGiIsWmzA4eZjZpvFz5rw8qqsqIaKAasOUfqHjgHHhyvUcBwQmbd-sIFb7Tgu1Uwq2Fw" style="clear: left; display: block; float: left; margin-bottom: 1em; margin-right: 1em; padding: 1em 0px; text-align: center;"><img alt="" border="0" data-original-height="108" data-original-width="347" src="https://blogger.googleusercontent.com/img/a/AVvXsEhhK5AND-53hO0WmWbQFMTGM0pr14PtX-ckX9CvIVr8PkMr_kmRLkQI-wK-V9Rmr5140t6sejSnmIYb9hhvRbXXWsdtdDVGG8KU7mMIMxmraFoMJUIwYPMzCTZGiIsWmzA4eZjZpvFz5rw8qqsqIaKAasOUfqHjgHHhyvUcBwQmbd-sIFb7Tgu1Uwq2Fw" /></a></div><p></p>