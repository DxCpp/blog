---
layout: post
title: Установка Telegram MTProto Proxy на Ubuntu Server
date: '2021-11-29T18:58:00.002+03:00'
author: Rishat
tags:
- Linux
- Telegram
- Мессджеры
modified_time: '2021-11-29T18:59:51.890+03:00'
thumbnail: https://blogger.googleusercontent.com/img/a/AVvXsEjjRyyco2a2FWGYo7e_DWyPunR7UfcAGHJsNwTbkUs7m1MQZ4wyi-VFr9mnJaFZa9-TQ71pf61oYztBZXl7T7JJUYqOHR5sVr1MFeWIIIR83_KoKyHM8OtNkBvMnRV7I11RIEHskcYQ1ZPp4k7W5jgR76abAkfIU09I6RdVpwUAWtUnKUKgOwnzNCdgAg=s72-c
blogger_id: tag:blogger.com,1999:blog-632559424411275764.post-2346640887254206884
blogger_orig_url: https://dxcpp.blogspot.com/2021/11/telegram-mtproto-proxy-ubuntu-server.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjjRyyco2a2FWGYo7e_DWyPunR7UfcAGHJsNwTbkUs7m1MQZ4wyi-VFr9mnJaFZa9-TQ71pf61oYztBZXl7T7JJUYqOHR5sVr1MFeWIIIR83_KoKyHM8OtNkBvMnRV7I11RIEHskcYQ1ZPp4k7W5jgR76abAkfIU09I6RdVpwUAWtUnKUKgOwnzNCdgAg=s706" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="420" data-original-width="706" height="190" src="https://blogger.googleusercontent.com/img/a/AVvXsEjjRyyco2a2FWGYo7e_DWyPunR7UfcAGHJsNwTbkUs7m1MQZ4wyi-VFr9mnJaFZa9-TQ71pf61oYztBZXl7T7JJUYqOHR5sVr1MFeWIIIR83_KoKyHM8OtNkBvMnRV7I11RIEHskcYQ1ZPp4k7W5jgR76abAkfIU09I6RdVpwUAWtUnKUKgOwnzNCdgAg=s320" width="320" /></a></div><p><a href="https://github.com/TelegramMessenger/MTProxy" target="_blank">MTProto</a> — протокол разработанный командой Дурова предназначенный для шифрования трафика месенджера Telegram.</p><p>MTProto Proxy — промежуточный сервер, выполняющий роль посредника между пользователем и целевым сервером позволяя получать доступ к сервису если по каким-то причинам он недоступен скрывая свой IP адрес и маскируя трафик.</p><p>Преимущества MTProto Proxy в сравнении socks:</p><p></p><ul style="text-align: left;"><li>Для подключения вместо логин/пароль, достаточно только пароля</li><li>Трафик не отличается от обычного HTTPS/TLS</li><li>Пароль не передается до сервера при подключении</li><li>Трафик зашифрован</li><li>Возможна работа через прокси только Telegram’a (другие приложения работать не будут)</li><li>Promoted каналы</li></ul><p></p><p>Как видим MTProto Proxy является узкоспециализированным средством, которое позволяет работать только с месенджером.</p><p>Огромным недостатком socks прокси является то, что логин и пароль при подключении к прокси передаётся в открытом виде. Данная особенность не даст возможность читать переписку, но понять что конкретный человек использует мессенджер вполне может.</p><p>В странах, которые используют DPI (в РФ — СОРМ) для анализа трафика, так и сделано. Это устройство разбирает туннель и смотрит, что же там внутри, если видит запрещенный трафик — блокирует.</p><p>Так же при расшаривании socks прокси он может попасть в глобальные списки и злоумышленники получали инструмент для незаконных действий. В таком случае при розыскных мероприятиях вопросы будут к держателю прокси сервера, т.к. злоумышленник использовал его в качестве промежуточного узла.</p><p>Promoted канал — канал, на который вы автоматически будете подписаны при подключении к прокси, он будет закреплен наверху списка и его нельзя удалить пока вы не отключитесь от данного прокси. Это дает возможность монетизировать трафик канала, тем самым поощряя держателя прокси.<span></span></p><a name='more'></a><p></p><h3 style="text-align: left;"><span style="font-size: medium;">Прочитав теорию, можно приступать:</span></h3><p>Самый простой вариант для запуска «своего» прокси:</p><p><span style="font-family: courier;">sudo docker run --name 'mtproto_proxy' --restart unless-stopped -p 1984:1984 -dti dotcypress/mtproxy -s 'proxy secret'</span></p><p>Ну а если мы хотим помучится, нам понадобится общий набор инструментов для сборки из исходного кода и пакеты разработки для openssl и zlib.</p><p><span style="font-family: courier;">apt install git curl build-essential libssl-dev zlib1g-dev</span></p><p>Клонируем из репы на GitHub и компилируем:</p><p><span style="font-family: courier;">cd ~</span></p><p><span style="font-family: courier;">git clone https://github.com/TelegramMessenger/MTProxy.git</span></p><p><span style="font-family: courier;">cd MTProxy/</span></p><p><span style="font-family: courier;">make</span></p><p>Раскидываем файлы по своим местам:</p><p><span style="font-family: courier;">cp objs/bin/mtproto-proxy /usr/bin/</span></p><p><span style="font-family: courier;">chmod 777 /usr/bin/mtproto-proxy</span></p><p><span style="font-family: courier;">cd /etc</span></p><p><span style="font-family: courier;">mkdir mtproto-proxy</span></p><p><span style="font-family: courier;">cd mtproto-proxy</span></p><p>Получить секретный файл, используемый для подключения к серверам телеграмм</p><p><span style="font-family: courier;">curl -s https://core.telegram.org/getProxySecret -o proxy-secret</span></p><p>Получить текущую конфигурацию. Может меняться и требует обновления</p><p><span style="font-family: courier;">curl -s https://core.telegram.org/getProxyConfig -o proxy-multi.conf</span></p><p>Создаем секрет, который будет использоваться пользователями для подключения к вашему прокси.</p><p><span style="font-family: courier;">head -c 16 /dev/urandom | xxd -ps</span></p><p>Создаем конфигурационный файл:</p><p><span style="font-family: courier;">sudo nano /etc/systemd/system/mtproto-proxy.service</span></p><p>Копируем туда текст с содержимым:</p><p><span style="font-family: courier;">[Unit]</span></p><p><span style="font-family: courier;">Description=MTProxy</span></p><p><span style="font-family: courier;">After=network.target</span></p><p><span style="font-family: courier;">[Service]</span></p><p><span style="font-family: courier;">ExecStart=/usr/bin/mtproto-proxy -u nobody -p 8888 -H 443 -S &lt;secret&gt; --aes-pwd /etc/mtproto-proxy/proxy-secret /etc/mtproto-proxy/proxy-multi.conf -M 1</span></p><p><span style="font-family: courier;">Restart=on-failure</span></p><p><span style="font-family: courier;">[Install]</span></p><p><span style="font-family: courier;">WantedBy=multi-user.target</span></p><p>где:</p><p>443 — порт, используемый клиентами для подключения к прокси.</p><p>8888 — локальный порт для получения статистики. Получить ее можно только локально через loopback. Пример: wget localhost:8888/stats</p><p>&lt;secret&gt; — идентификатор полученный при генерировании его ранее. На сервере может быть несколько секретов. Пример: -S &lt;secret1&gt; -S &lt;secret2&gt;</p><p>Если сервер расположен за NAT, требуется добавить параметр —nat-info &lt;arg&gt; &lt;Внутренний адрес&gt;:&lt;Внешний адрес&gt;. Не забываем покинуть порты.</p><p>Другие команды можно посмотреть после старта сервиса командой:&nbsp;</p><p><span style="font-family: courier;">mtproto-proxy -h</span></p><p>Перезагружаем systemd для поиска новых или измененных юнитов:</p><p><span style="font-family: courier;">systemctl daemon-reload</span></p><p>Запускаем службу с добавлением ее в автозагрузку:</p><p><span style="font-family: courier;">systemctl restart mtproto-proxy</span></p><p><span style="font-family: courier;">systemctl enable mtproto-proxy</span></p><p>Все — готово. Для того что бы пользователи смогли подключиться к прокси — генерируем ссылку:</p><p><span style="font-family: courier;">tg://proxy?server=&lt;IP сервера&gt;&amp;port=&lt;ПОРТ&gt;&amp;secret=&lt;СЕКРЕТ&gt;</span></p><p>Для включения рекламы promoted канала требуется написать этому боту @MTProxybot и зарегистрировав ваш сервер. После этого он вам выдаст TAG — персональный идентификатор прокси для отслеживании статистики и установки рекламы каналов. Его нужно вписать в mtproto-proxy.service, добавлением параметра: -P &lt;TAG&gt;. Перезагружаем прокси (systemctl restart mtproto-proxy) и можно добавлять канал для рекламы средствами бота. На этом установка является завершенной.</p>